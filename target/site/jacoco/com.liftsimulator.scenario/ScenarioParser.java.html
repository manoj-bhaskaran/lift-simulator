<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScenarioParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Lift Simulator</a> &gt; <a href="index.source.html" class="el_package">com.liftsimulator.scenario</a> &gt; <span class="el_source">ScenarioParser.java</span></div><h1>ScenarioParser.java</h1><pre class="source lang-java linenums">package com.liftsimulator.scenario;

import com.liftsimulator.domain.ControllerStrategy;
import com.liftsimulator.domain.Direction;
import com.liftsimulator.domain.IdleParkingMode;
import com.liftsimulator.domain.LiftRequest;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

<span class="nc" id="L19">public class ScenarioParser {</span>
    private static final int MAX_EVENTS = 10000;
    private static final int MAX_TICKS = 1000000;

    public ScenarioDefinition parse(Path path) throws IOException {
<span class="nc" id="L24">        try (InputStream inputStream = Files.newInputStream(path)) {</span>
<span class="nc" id="L25">            return parse(inputStream, path.toString());</span>
        }
    }

    public ScenarioDefinition parseResource(String resourcePath) throws IOException {
<span class="nc" id="L30">        InputStream inputStream = ScenarioParser.class.getResourceAsStream(resourcePath);</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">        if (inputStream == null) {</span>
<span class="nc" id="L32">            throw new IOException(&quot;Scenario resource not found: &quot; + resourcePath);</span>
        }
<span class="nc" id="L34">        try (InputStream stream = inputStream) {</span>
<span class="nc" id="L35">            return parse(stream, resourcePath);</span>
        }
    }

    private ScenarioDefinition parse(InputStream inputStream, String sourceName) throws IOException {
<span class="nc" id="L40">        String scenarioName = &quot;Unnamed Scenario&quot;;</span>
<span class="nc" id="L41">        Integer totalTicks = null;</span>
<span class="nc" id="L42">        List&lt;ScenarioEvent&gt; events = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L43">        Integer minFloor = null;</span>
<span class="nc" id="L44">        Integer maxFloor = null;</span>
<span class="nc" id="L45">        Integer configuredMinFloor = null;</span>
<span class="nc" id="L46">        Integer configuredMaxFloor = null;</span>
<span class="nc" id="L47">        Integer initialFloor = null;</span>
<span class="nc" id="L48">        Integer travelTicksPerFloor = null;</span>
<span class="nc" id="L49">        Integer doorTransitionTicks = null;</span>
<span class="nc" id="L50">        Integer doorDwellTicks = null;</span>
<span class="nc" id="L51">        Integer doorReopenWindowTicks = null;</span>
<span class="nc" id="L52">        Integer homeFloor = null;</span>
<span class="nc" id="L53">        Integer idleTimeoutTicks = null;</span>
<span class="nc" id="L54">        IdleParkingMode idleParkingMode = null;</span>
<span class="nc" id="L55">        ControllerStrategy controllerStrategy = null;</span>

<span class="nc" id="L57">        try (BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream, StandardCharsets.UTF_8))) {</span>
            String line;
<span class="nc" id="L59">            int lineNumber = 0;</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            while ((line = reader.readLine()) != null) {</span>
<span class="nc" id="L61">                lineNumber++;</span>
<span class="nc" id="L62">                String trimmed = line.trim();</span>
<span class="nc bnc" id="L63" title="All 4 branches missed.">                if (trimmed.isEmpty() || trimmed.startsWith(&quot;#&quot;)) {</span>
<span class="nc" id="L64">                    continue;</span>
                }

<span class="nc bnc" id="L67" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;name:&quot;)) {</span>
<span class="nc" id="L68">                    scenarioName = trimmed.substring(&quot;name:&quot;.length()).trim();</span>
<span class="nc" id="L69">                    continue;</span>
                }

<span class="nc bnc" id="L72" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;ticks:&quot;)) {</span>
<span class="nc" id="L73">                    String value = trimmed.substring(&quot;ticks:&quot;.length()).trim();</span>
<span class="nc" id="L74">                    totalTicks = Integer.parseInt(value);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                    if (totalTicks &gt; MAX_TICKS) {</span>
<span class="nc" id="L76">                        throw new IllegalArgumentException(</span>
                                &quot;Scenario exceeds maximum tick limit: &quot; + MAX_TICKS
                        );
                    }
                    continue;
                }

<span class="nc bnc" id="L83" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;min_floor:&quot;)) {</span>
<span class="nc" id="L84">                    configuredMinFloor = parseIntValue(trimmed, &quot;min_floor:&quot;);</span>
<span class="nc" id="L85">                    continue;</span>
                }

<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;max_floor:&quot;)) {</span>
<span class="nc" id="L89">                    configuredMaxFloor = parseIntValue(trimmed, &quot;max_floor:&quot;);</span>
<span class="nc" id="L90">                    continue;</span>
                }

<span class="nc bnc" id="L93" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;initial_floor:&quot;)) {</span>
<span class="nc" id="L94">                    initialFloor = parseIntValue(trimmed, &quot;initial_floor:&quot;);</span>
<span class="nc" id="L95">                    continue;</span>
                }

<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;travel_ticks_per_floor:&quot;)) {</span>
<span class="nc" id="L99">                    travelTicksPerFloor = parseIntValue(trimmed, &quot;travel_ticks_per_floor:&quot;);</span>
<span class="nc" id="L100">                    continue;</span>
                }

<span class="nc bnc" id="L103" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;door_transition_ticks:&quot;)) {</span>
<span class="nc" id="L104">                    doorTransitionTicks = parseIntValue(trimmed, &quot;door_transition_ticks:&quot;);</span>
<span class="nc" id="L105">                    continue;</span>
                }

<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;door_dwell_ticks:&quot;)) {</span>
<span class="nc" id="L109">                    doorDwellTicks = parseIntValue(trimmed, &quot;door_dwell_ticks:&quot;);</span>
<span class="nc" id="L110">                    continue;</span>
                }

<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;door_reopen_window_ticks:&quot;)) {</span>
<span class="nc" id="L114">                    doorReopenWindowTicks = parseIntValue(trimmed, &quot;door_reopen_window_ticks:&quot;);</span>
<span class="nc" id="L115">                    continue;</span>
                }

<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;home_floor:&quot;)) {</span>
<span class="nc" id="L119">                    homeFloor = parseIntValue(trimmed, &quot;home_floor:&quot;);</span>
<span class="nc" id="L120">                    continue;</span>
                }

<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;idle_timeout_ticks:&quot;)) {</span>
<span class="nc" id="L124">                    idleTimeoutTicks = parseIntValue(trimmed, &quot;idle_timeout_ticks:&quot;);</span>
<span class="nc" id="L125">                    continue;</span>
                }

<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;idle_parking_mode:&quot;)) {</span>
<span class="nc" id="L129">                    String value = trimmed.substring(&quot;idle_parking_mode:&quot;.length()).trim();</span>
                    try {
<span class="nc" id="L131">                        idleParkingMode = IdleParkingMode.valueOf(value.toUpperCase(Locale.ROOT));</span>
<span class="nc" id="L132">                    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L133">                        throw new IllegalArgumentException(</span>
<span class="nc" id="L134">                                errorMessage(sourceName, lineNumber, &quot;Invalid idle_parking_mode: &quot; + value)</span>
                        );
<span class="nc" id="L136">                    }</span>
                    continue;
                }

<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (trimmed.startsWith(&quot;controller_strategy:&quot;)) {</span>
<span class="nc" id="L141">                    String value = trimmed.substring(&quot;controller_strategy:&quot;.length()).trim();</span>
                    try {
<span class="nc" id="L143">                        controllerStrategy = ControllerStrategy.valueOf(value.toUpperCase(Locale.ROOT));</span>
<span class="nc" id="L144">                    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L145">                        throw new IllegalArgumentException(</span>
<span class="nc" id="L146">                                errorMessage(sourceName, lineNumber, &quot;Invalid controller_strategy: &quot; + value)</span>
                        );
<span class="nc" id="L148">                    }</span>
                    continue;
                }

<span class="nc" id="L152">                String[] tokens = trimmed.split(&quot;\\s*,\\s*&quot;);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (tokens.length &lt; 2) {</span>
<span class="nc" id="L154">                    throw new IllegalArgumentException(errorMessage(sourceName, lineNumber, &quot;Invalid event line: &quot; + line));</span>
                }

<span class="nc" id="L157">                long tick = parseTick(tokens[0], sourceName, lineNumber);</span>
<span class="nc" id="L158">                String action = tokens[1].toLowerCase(Locale.ROOT);</span>
<span class="nc" id="L159">                Integer floorValue = extractFloorValue(action, tokens);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (floorValue != null) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                    minFloor = minFloor == null ? floorValue : Math.min(minFloor, floorValue);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                    maxFloor = maxFloor == null ? floorValue : Math.max(maxFloor, floorValue);</span>
                }
<span class="nc" id="L164">                ScenarioEvent event = parseEvent(tick, action, tokens, sourceName, lineNumber);</span>
<span class="nc" id="L165">                events.add(event);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                if (events.size() &gt; MAX_EVENTS) {</span>
<span class="nc" id="L167">                    throw new IllegalArgumentException(</span>
                            &quot;Scenario exceeds maximum event limit: &quot; + MAX_EVENTS
                    );
                }
<span class="nc" id="L171">            }</span>
        }

<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (totalTicks == null) {</span>
<span class="nc" id="L175">            throw new IllegalArgumentException(&quot;Scenario must define ticks in &quot; + sourceName);</span>
        }

<span class="nc" id="L178">        return new ScenarioDefinition(</span>
                scenarioName,
<span class="nc" id="L180">                totalTicks,</span>
                events,
                minFloor,
                maxFloor,
                configuredMinFloor,
                configuredMaxFloor,
                initialFloor,
                travelTicksPerFloor,
                doorTransitionTicks,
                doorDwellTicks,
                doorReopenWindowTicks,
                homeFloor,
                idleTimeoutTicks,
                idleParkingMode,
                controllerStrategy
        );
    }

    private Integer extractFloorValue(String action, String[] tokens) {
<span class="nc bnc" id="L199" title="All 4 branches missed.">        if (&quot;car_call&quot;.equals(action) &amp;&amp; tokens.length &gt;= 4) {</span>
<span class="nc" id="L200">            return Integer.parseInt(tokens[3]);</span>
        }
<span class="nc bnc" id="L202" title="All 4 branches missed.">        if (&quot;hall_call&quot;.equals(action) &amp;&amp; tokens.length &gt;= 4) {</span>
<span class="nc" id="L203">            return Integer.parseInt(tokens[3]);</span>
        }
<span class="nc" id="L205">        return null;</span>
    }

    private ScenarioEvent parseEvent(long tick, String action, String[] tokens, String sourceName, int lineNumber) {
<span class="nc bnc" id="L209" title="All 6 branches missed.">        return switch (action) {</span>
<span class="nc" id="L210">            case &quot;car_call&quot; -&gt; parseCarCall(tick, tokens, sourceName, lineNumber);</span>
<span class="nc" id="L211">            case &quot;hall_call&quot; -&gt; parseHallCall(tick, tokens, sourceName, lineNumber);</span>
<span class="nc" id="L212">            case &quot;cancel&quot; -&gt; parseCancel(tick, tokens, sourceName, lineNumber);</span>
<span class="nc" id="L213">            case &quot;out_of_service&quot; -&gt; new ScenarioEvent(tick, &quot;Out of service&quot;, context -&gt; {</span>
<span class="nc" id="L214">                context.getController().takeOutOfService();</span>
<span class="nc" id="L215">                context.getEngine().setOutOfService();</span>
<span class="nc" id="L216">            });</span>
<span class="nc" id="L217">            case &quot;return_to_service&quot; -&gt; new ScenarioEvent(tick, &quot;Return to service&quot;, context -&gt; {</span>
<span class="nc" id="L218">                context.getController().returnToService();</span>
<span class="nc" id="L219">                context.getEngine().returnToService();</span>
<span class="nc" id="L220">            });</span>
<span class="nc" id="L221">            default -&gt; throw new IllegalArgumentException(errorMessage(sourceName, lineNumber, &quot;Unknown action: &quot; + action));</span>
        };
    }

    private ScenarioEvent parseCarCall(long tick, String[] tokens, String sourceName, int lineNumber) {
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (tokens.length != 4) {</span>
<span class="nc" id="L227">            throw new IllegalArgumentException(errorMessage(sourceName, lineNumber, &quot;car_call requires tick, alias, destination&quot;));</span>
        }
<span class="nc" id="L229">        String alias = tokens[2];</span>
<span class="nc" id="L230">        int destination = Integer.parseInt(tokens[3]);</span>
<span class="nc" id="L231">        String description = String.format(&quot;Car call %s to %d&quot;, alias, destination);</span>
<span class="nc" id="L232">        return new ScenarioEvent(tick, description, context -&gt; {</span>
<span class="nc" id="L233">            LiftRequest request = LiftRequest.carCall(destination);</span>
<span class="nc" id="L234">            context.addRequest(request);</span>
<span class="nc" id="L235">            context.registerAlias(alias, request.getId());</span>
<span class="nc" id="L236">        });</span>
    }

    private ScenarioEvent parseHallCall(long tick, String[] tokens, String sourceName, int lineNumber) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (tokens.length != 5) {</span>
<span class="nc" id="L241">            throw new IllegalArgumentException(errorMessage(sourceName, lineNumber, &quot;hall_call requires tick, alias, floor, direction&quot;));</span>
        }
<span class="nc" id="L243">        String alias = tokens[2];</span>
<span class="nc" id="L244">        int floor = Integer.parseInt(tokens[3]);</span>
<span class="nc" id="L245">        Direction direction = Direction.valueOf(tokens[4].toUpperCase(Locale.ROOT));</span>
<span class="nc" id="L246">        String description = String.format(&quot;Hall call %s at %d %s&quot;, alias, floor, direction);</span>
<span class="nc" id="L247">        return new ScenarioEvent(tick, description, context -&gt; {</span>
<span class="nc" id="L248">            LiftRequest request = LiftRequest.hallCall(floor, direction);</span>
<span class="nc" id="L249">            context.addRequest(request);</span>
<span class="nc" id="L250">            context.registerAlias(alias, request.getId());</span>
<span class="nc" id="L251">        });</span>
    }

    private ScenarioEvent parseCancel(long tick, String[] tokens, String sourceName, int lineNumber) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (tokens.length != 3) {</span>
<span class="nc" id="L256">            throw new IllegalArgumentException(errorMessage(sourceName, lineNumber, &quot;cancel requires tick and alias&quot;));</span>
        }
<span class="nc" id="L258">        String alias = tokens[2];</span>
<span class="nc" id="L259">        String description = String.format(&quot;Cancel %s&quot;, alias);</span>
<span class="nc" id="L260">        return new ScenarioEvent(tick, description, context -&gt; {</span>
<span class="nc" id="L261">            Long requestId = context.resolveAlias(alias);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">            if (requestId == null) {</span>
<span class="nc" id="L263">                throw new IllegalArgumentException(&quot;Unknown request alias: &quot; + alias);</span>
            }
<span class="nc" id="L265">            context.getController().cancelRequest(requestId);</span>
<span class="nc" id="L266">        });</span>
    }

    private String errorMessage(String sourceName, int lineNumber, String message) {
<span class="nc" id="L270">        return String.format(&quot;%s (line %d): %s&quot;, sourceName, lineNumber, message);</span>
    }

    private long parseTick(String token, String sourceName, int lineNumber) {
        try {
<span class="nc" id="L275">            long tick = Long.parseLong(token);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (tick &lt; 0) {</span>
<span class="nc" id="L277">                throw new IllegalArgumentException(errorMessage(sourceName, lineNumber, &quot;Tick must be non-negative&quot;));</span>
            }
<span class="nc" id="L279">            return tick;</span>
<span class="nc" id="L280">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L281">            throw new IllegalArgumentException(</span>
<span class="nc" id="L282">                    errorMessage(sourceName, lineNumber, &quot;Invalid tick value: &quot; + token),</span>
                    e
            );
        }
    }

    private Integer parseIntValue(String trimmed, String prefix) {
<span class="nc" id="L289">        String value = trimmed.substring(prefix.length()).trim();</span>
<span class="nc" id="L290">        return Integer.parseInt(value);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>