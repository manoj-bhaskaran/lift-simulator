<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StateTransitionValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Lift Simulator</a> &gt; <a href="index.source.html" class="el_package">com.liftsimulator.engine</a> &gt; <span class="el_source">StateTransitionValidator.java</span></div><h1>StateTransitionValidator.java</h1><pre class="source lang-java linenums">package com.liftsimulator.engine;

import com.liftsimulator.domain.Action;
import com.liftsimulator.domain.LiftStatus;

import java.util.EnumMap;
import java.util.EnumSet;
import java.util.Map;
import java.util.Set;
import java.util.logging.Logger;

/**
 * Validates and manages state transitions for the lift state machine.
 * Ensures that only valid transitions occur and logs any invalid attempts.
 */
<span class="nc" id="L16">public class StateTransitionValidator {</span>
<span class="nc" id="L17">    private static final Logger LOGGER = Logger.getLogger(StateTransitionValidator.class.getName());</span>

    // Define valid state transitions based on actions.
<span class="nc" id="L20">    private static final Map&lt;LiftStatus, Set&lt;LiftStatus&gt;&gt; VALID_TRANSITIONS = new EnumMap&lt;&gt;(LiftStatus.class);</span>

    static {
        // IDLE can transition to: MOVING_UP, MOVING_DOWN, DOORS_OPENING, OUT_OF_SERVICE.
<span class="nc" id="L24">        VALID_TRANSITIONS.put(LiftStatus.IDLE, EnumSet.of(</span>
                LiftStatus.IDLE,
                LiftStatus.MOVING_UP,
                LiftStatus.MOVING_DOWN,
                LiftStatus.DOORS_OPENING,
                LiftStatus.OUT_OF_SERVICE
        ));

        /*
         * MOVING_UP can transition to: MOVING_UP, IDLE, OUT_OF_SERVICE.
         * Cannot open doors while moving - must stop first.
         */
<span class="nc" id="L36">        VALID_TRANSITIONS.put(LiftStatus.MOVING_UP, EnumSet.of(</span>
                LiftStatus.MOVING_UP,
                LiftStatus.IDLE,
                LiftStatus.OUT_OF_SERVICE
        ));

        /*
         * MOVING_DOWN can transition to: MOVING_DOWN, IDLE, OUT_OF_SERVICE.
         * Cannot open doors while moving - must stop first.
         */
<span class="nc" id="L46">        VALID_TRANSITIONS.put(LiftStatus.MOVING_DOWN, EnumSet.of(</span>
                LiftStatus.MOVING_DOWN,
                LiftStatus.IDLE,
                LiftStatus.OUT_OF_SERVICE
        ));

        /*
         * DOORS_OPENING can transition to: DOORS_OPEN, DOORS_CLOSING (abort), OUT_OF_SERVICE.
         * Cannot go directly to IDLE - must close doors first.
         */
<span class="nc" id="L56">        VALID_TRANSITIONS.put(LiftStatus.DOORS_OPENING, EnumSet.of(</span>
                LiftStatus.DOORS_OPENING,
                LiftStatus.DOORS_OPEN,
                LiftStatus.DOORS_CLOSING,
                LiftStatus.OUT_OF_SERVICE
        ));

        // DOORS_OPEN can transition to: DOORS_CLOSING, OUT_OF_SERVICE.
<span class="nc" id="L64">        VALID_TRANSITIONS.put(LiftStatus.DOORS_OPEN, EnumSet.of(</span>
                LiftStatus.DOORS_OPEN,
                LiftStatus.DOORS_CLOSING,
                LiftStatus.OUT_OF_SERVICE
        ));

        // DOORS_CLOSING can transition to: IDLE, DOORS_OPENING (re-open), OUT_OF_SERVICE.
<span class="nc" id="L71">        VALID_TRANSITIONS.put(LiftStatus.DOORS_CLOSING, EnumSet.of(</span>
                LiftStatus.DOORS_CLOSING,
                LiftStatus.IDLE,
                LiftStatus.DOORS_OPENING,
                LiftStatus.OUT_OF_SERVICE
        ));

        // OUT_OF_SERVICE can transition to: IDLE (for maintenance recovery).
<span class="nc" id="L79">        VALID_TRANSITIONS.put(LiftStatus.OUT_OF_SERVICE, EnumSet.of(</span>
                LiftStatus.OUT_OF_SERVICE,
                LiftStatus.IDLE
        ));
<span class="nc" id="L83">    }</span>

    /**
     * Determines the next lift status based on the current status and requested action.
     *
     * @param currentStatus the current lift status
     * @param action the action being performed
     * @return the next lift status after applying the action
     * @see LiftStatus for the available lift states
     * @see Action for the set of actions that drive transitions
     */
    public static LiftStatus getNextStatus(LiftStatus currentStatus, Action action) {
<span class="nc bnc" id="L95" title="All 5 branches missed.">        return switch (action) {</span>
<span class="nc" id="L96">            case MOVE_UP -&gt; LiftStatus.MOVING_UP;</span>
<span class="nc" id="L97">            case MOVE_DOWN -&gt; LiftStatus.MOVING_DOWN;</span>
<span class="nc" id="L98">            case OPEN_DOOR -&gt; LiftStatus.DOORS_OPENING;</span>
<span class="nc" id="L99">            case CLOSE_DOOR -&gt; LiftStatus.DOORS_CLOSING;</span>
            case IDLE -&gt; {
                // When IDLE action is taken, transition based on current state.
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (currentStatus == LiftStatus.DOORS_CLOSING) {</span>
<span class="nc" id="L103">                    yield LiftStatus.IDLE;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                } else if (currentStatus == LiftStatus.DOORS_OPENING) {</span>
<span class="nc" id="L105">                    yield LiftStatus.DOORS_OPEN;</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">                } else if (currentStatus == LiftStatus.MOVING_UP ||</span>
                           currentStatus == LiftStatus.MOVING_DOWN) {
<span class="nc" id="L108">                    yield LiftStatus.IDLE;</span>
                } else {
<span class="nc" id="L110">                    yield currentStatus;</span>
                }
            }
        };
    }

    /**
     * Validates whether a transition between lift statuses is allowed.
     *
     * @param fromStatus the current status
     * @param toStatus the target status
     * @return true if the transition is valid, false otherwise
     * @see LiftStatus for the complete lift state machine
     */
    public static boolean isValidTransition(LiftStatus fromStatus, LiftStatus toStatus) {
<span class="nc" id="L125">        Set&lt;LiftStatus&gt; validNextStates = VALID_TRANSITIONS.get(fromStatus);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (validNextStates == null) {</span>
<span class="nc" id="L127">            LOGGER.warning(&quot;No valid transitions defined for status: &quot; + fromStatus);</span>
<span class="nc" id="L128">            return false;</span>
        }

<span class="nc" id="L131">        boolean isValid = validNextStates.contains(toStatus);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (!isValid) {</span>
<span class="nc" id="L133">            LOGGER.warning(String.format(</span>
                &quot;Invalid state transition attempted: %s -&gt; %s&quot;,
                fromStatus,
                toStatus
            ));
        }

<span class="nc" id="L140">        return isValid;</span>
    }

    /**
     * Validates whether an action is allowed in the current status.
     *
     * @param currentStatus the current lift status
     * @param action the action to validate
     * @return true if the action is allowed, false otherwise
     * @see Action for the action set validated by this method
     */
    public static boolean isActionAllowed(LiftStatus currentStatus, Action action) {
<span class="nc" id="L152">        LiftStatus nextStatus = getNextStatus(currentStatus, action);</span>
<span class="nc" id="L153">        return isValidTransition(currentStatus, nextStatus);</span>
    }

    /**
     * Gets the set of valid next states from the current status.
     *
     * @param currentStatus the current status
     * @return set of valid next states
     * @see LiftStatus for the defined states
     */
    public static Set&lt;LiftStatus&gt; getValidNextStates(LiftStatus currentStatus) {
<span class="nc" id="L164">        return VALID_TRANSITIONS.getOrDefault(currentStatus, EnumSet.noneOf(LiftStatus.class));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>