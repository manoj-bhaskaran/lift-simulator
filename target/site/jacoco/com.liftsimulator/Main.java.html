<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Main.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Lift Simulator</a> &gt; <a href="index.source.html" class="el_package">com.liftsimulator</a> &gt; <span class="el_source">Main.java</span></div><h1>Main.java</h1><pre class="source lang-java linenums">package com.liftsimulator;

import com.liftsimulator.domain.CarCall;
import com.liftsimulator.domain.ControllerStrategy;
import com.liftsimulator.domain.Direction;
import com.liftsimulator.domain.DoorState;
import com.liftsimulator.domain.HallCall;
import com.liftsimulator.domain.IdleParkingMode;
import com.liftsimulator.domain.LiftRequest;
import com.liftsimulator.domain.LiftState;
import com.liftsimulator.domain.LiftStatus;
import com.liftsimulator.domain.RequestState;
import com.liftsimulator.engine.ControllerFactory;
import com.liftsimulator.engine.RequestManagingLiftController;
import com.liftsimulator.engine.SimulationEngine;
import java.io.IOException;
import java.io.InputStream;
import java.util.Comparator;
import java.util.LinkedHashMap;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.Properties;
import java.util.stream.Collectors;

/**
 * Main entry point for the lift simulator.
 * Runs a demonstration of a lift controller with realistic scenarios.
 */
<span class="nc" id="L30">public class Main {</span>
<span class="nc" id="L31">    private static final ControllerStrategy DEFAULT_CONTROLLER_STRATEGY = ControllerStrategy.NEAREST_REQUEST_ROUTING;</span>
<span class="nc" id="L32">    private static final IdleParkingMode DEFAULT_IDLE_PARKING_MODE = IdleParkingMode.PARK_TO_HOME_FLOOR;</span>

    public static void main(String[] args) {
        // Parse command-line arguments.
<span class="nc" id="L36">        ControllerStrategy controllerStrategy = DEFAULT_CONTROLLER_STRATEGY;</span>
<span class="nc" id="L37">        IdleParkingMode idleParkingMode = DEFAULT_IDLE_PARKING_MODE;</span>

<span class="nc bnc" id="L39" title="All 2 branches missed.">        for (String arg : args) {</span>
<span class="nc bnc" id="L40" title="All 4 branches missed.">            if (arg.equals(&quot;--help&quot;) || arg.equals(&quot;-h&quot;)) {</span>
<span class="nc" id="L41">                printUsage();</span>
<span class="nc" id="L42">                System.exit(0);</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">            } else if (arg.startsWith(&quot;--strategy=&quot;)) {</span>
<span class="nc" id="L44">                String strategy = arg.substring(&quot;--strategy=&quot;.length());</span>
                try {
<span class="nc" id="L46">                    controllerStrategy = parseControllerStrategy(strategy);</span>
<span class="nc" id="L47">                } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L48">                    System.err.println(&quot;Invalid strategy: &quot; + strategy);</span>
<span class="nc" id="L49">                    System.err.println(&quot;Valid strategies: nearest-request, directional-scan&quot;);</span>
<span class="nc" id="L50">                    printUsage();</span>
<span class="nc" id="L51">                    System.exit(1);</span>
<span class="nc" id="L52">                }</span>
<span class="nc" id="L53">            } else {</span>
<span class="nc" id="L54">                System.err.println(&quot;Unknown argument: &quot; + arg);</span>
<span class="nc" id="L55">                printUsage();</span>
<span class="nc" id="L56">                System.exit(1);</span>
            }
        }

<span class="nc" id="L60">        System.out.println(&quot;=== Lift Simulator - Controller Demo ===&quot;);</span>
<span class="nc" id="L61">        System.out.println(&quot;Version: &quot; + resolveVersion());</span>
<span class="nc" id="L62">        System.out.println(&quot;Controller Strategy: &quot; + controllerStrategy);</span>
<span class="nc" id="L63">        System.out.println(&quot;Idle Parking Mode: &quot; + idleParkingMode);</span>
<span class="nc" id="L64">        System.out.println(&quot;Starting simulation...\n&quot;);</span>

        // Create controller using factory with configured strategy and parking mode.
<span class="nc" id="L67">        RequestManagingLiftController controller = (RequestManagingLiftController) ControllerFactory.createController(</span>
                controllerStrategy,
                0,                    // homeFloor
                5,                    // idleTimeoutTicks
                idleParkingMode
        );
<span class="nc" id="L73">        SimulationEngine engine = SimulationEngine.builder(controller, 0, 10).build();</span>
<span class="nc" id="L74">        Map&lt;Long, RequestLifecycle&gt; lifecycles = new LinkedHashMap&lt;&gt;();</span>

        // Add some requests to simulate real usage.
<span class="nc" id="L77">        System.out.println(&quot;Requests:&quot;);</span>
<span class="nc" id="L78">        System.out.println(&quot;  - Car call to floor 3&quot;);</span>
<span class="nc" id="L79">        System.out.println(&quot;  - Hall call from floor 7 going UP&quot;);</span>
<span class="nc" id="L80">        System.out.println(&quot;  - Car call to floor 5&quot;);</span>
<span class="nc" id="L81">        System.out.println(&quot;  - Car call to floor 8 (will be cancelled at tick 15)&quot;);</span>
<span class="nc" id="L82">        System.out.println(&quot;  - Graceful out-of-service initiated at tick 25&quot;);</span>
<span class="nc" id="L83">        System.out.println(&quot;  - Return to service at tick 35&quot;);</span>
<span class="nc" id="L84">        System.out.println();</span>

<span class="nc" id="L86">        controller.addCarCall(new CarCall(3));</span>
<span class="nc" id="L87">        controller.addHallCall(new HallCall(7, Direction.UP));</span>
<span class="nc" id="L88">        controller.addCarCall(new CarCall(5));</span>

        // Add a request that we'll cancel later to demonstrate cancellation.
<span class="nc" id="L91">        LiftRequest requestToCancel = LiftRequest.carCall(8);</span>
<span class="nc" id="L92">        controller.addRequest(requestToCancel);</span>
<span class="nc" id="L93">        recordRequestCreations(controller, engine.getCurrentTick(), lifecycles);</span>

        // Run simulation for 50 ticks to show out-of-service scenario.
<span class="nc" id="L96">        int tickCount = 50;</span>
<span class="nc" id="L97">        System.out.println(String.format(&quot;%-6s %-8s %-15s %-12s %-10s %-12s %-15s&quot;,</span>
                &quot;Tick&quot;, &quot;Floor&quot;, &quot;Status&quot;, &quot;Direction&quot;, &quot;Door&quot;, &quot;Requests&quot;, &quot;Notes&quot;));
<span class="nc" id="L99">        System.out.println(&quot;-------------------------------------------------------------------------------------------&quot;);</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">        for (int i = 0; i &lt; tickCount; i++) {</span>
<span class="nc" id="L102">            LiftState state = engine.getCurrentState();</span>
<span class="nc" id="L103">            String notes = &quot;&quot;;</span>

            // Cancel request to floor 8 at tick 15 to demonstrate cancellation.
<span class="nc bnc" id="L106" title="All 4 branches missed.">            if (i == 15 &amp;&amp; !requestToCancel.isTerminal()) {</span>
<span class="nc" id="L107">                controller.cancelRequest(requestToCancel.getId());</span>
<span class="nc" id="L108">                notes = &quot;*** CANCELLED request to floor 8 ***&quot;;</span>
            }

            // Take lift out of service at tick 25 (graceful shutdown begins).
<span class="nc bnc" id="L112" title="All 4 branches missed.">            if (i == 25 &amp;&amp; state.getStatus() != LiftStatus.OUT_OF_SERVICE) {</span>
<span class="nc" id="L113">                controller.takeOutOfService();</span>
<span class="nc" id="L114">                engine.setOutOfService();</span>
<span class="nc" id="L115">                notes = &quot;*** INITIATING OUT-OF-SERVICE (graceful shutdown) ***&quot;;</span>
            }

            // Return lift to service (whenever it's actually OUT_OF_SERVICE).
<span class="nc bnc" id="L119" title="All 4 branches missed.">            if (i == 35 &amp;&amp; state.getStatus() == LiftStatus.OUT_OF_SERVICE) {</span>
<span class="nc" id="L120">                controller.returnToService();</span>
<span class="nc" id="L121">                engine.returnToService();</span>
<span class="nc" id="L122">                notes = &quot;*** RETURNED TO SERVICE ***&quot;;</span>
            }

            // Add a new request after returning to service.
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (i == 36) {</span>
<span class="nc" id="L127">                controller.addCarCall(new CarCall(4));</span>
<span class="nc" id="L128">                notes = &quot;*** NEW request to floor 4 ***&quot;;</span>
            }

<span class="nc" id="L131">            recordRequestCreations(controller, engine.getCurrentTick(), lifecycles);</span>
<span class="nc" id="L132">            recordTerminalRequests(controller, engine.getCurrentTick(), lifecycles);</span>

            // Add contextual notes.
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (i == 0) notes = &quot;(Starting)&quot;;</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">            if (state.getFloor() == 3 &amp;&amp; state.getDoorState() == DoorState.OPEN) {</span>
<span class="nc" id="L137">                notes = &quot;(Servicing floor 3)&quot;;</span>
            }
<span class="nc bnc" id="L139" title="All 4 branches missed.">            if (state.getFloor() == 4 &amp;&amp; state.getDoorState() == DoorState.OPEN) {</span>
<span class="nc" id="L140">                notes = &quot;(Servicing floor 4)&quot;;</span>
            }
<span class="nc bnc" id="L142" title="All 4 branches missed.">            if (state.getFloor() == 5 &amp;&amp; state.getDoorState() == DoorState.OPEN) {</span>
<span class="nc" id="L143">                notes = &quot;(Servicing floor 5)&quot;;</span>
            }
<span class="nc bnc" id="L145" title="All 4 branches missed.">            if (state.getFloor() == 7 &amp;&amp; state.getDoorState() == DoorState.OPEN) {</span>
<span class="nc" id="L146">                notes = &quot;(Servicing floor 7)&quot;;</span>
            }

<span class="nc" id="L149">            String requestStatus = formatRequestStatus(controller);</span>

<span class="nc" id="L151">            System.out.println(String.format(&quot;%-6d %-8d %-15s %-12s %-10s %-12s %-15s&quot;,</span>
<span class="nc" id="L152">                    engine.getCurrentTick(),</span>
<span class="nc" id="L153">                    state.getFloor(),</span>
<span class="nc" id="L154">                    state.getStatus(),</span>
<span class="nc" id="L155">                    state.getDirection(),</span>
<span class="nc" id="L156">                    state.getDoorState(),</span>
                    requestStatus,
                    notes));

<span class="nc" id="L160">            engine.tick();</span>
        }

<span class="nc" id="L163">        recordTerminalRequests(controller, engine.getCurrentTick(), lifecycles);</span>

<span class="nc" id="L165">        System.out.println(&quot;\nSimulation completed successfully!&quot;);</span>
<span class="nc" id="L166">        System.out.println(&quot;All requests serviced using &quot; + controllerStrategy + &quot; scheduling.&quot;);</span>
<span class="nc" id="L167">        System.out.println(&quot;\nKey events:&quot;);</span>
<span class="nc" id="L168">        System.out.println(&quot;  - Request to floor 8 was cancelled at tick 15 and never serviced.&quot;);</span>
<span class="nc" id="L169">        System.out.println(&quot;  - Out-of-service initiated at tick 25 with graceful shutdown sequence:&quot;);</span>
<span class="nc" id="L170">        System.out.println(&quot;    * All pending requests cancelled immediately&quot;);</span>
<span class="nc" id="L171">        System.out.println(&quot;    * Lift completes movement to next floor (if moving)&quot;);</span>
<span class="nc" id="L172">        System.out.println(&quot;    * Doors open to allow passenger exit, then close&quot;);</span>
<span class="nc" id="L173">        System.out.println(&quot;    * Transitions to OUT_OF_SERVICE state&quot;);</span>
<span class="nc" id="L174">        System.out.println(&quot;  - Lift returned to service at tick 35.&quot;);</span>
<span class="nc" id="L175">        System.out.println(&quot;  - New request to floor 4 added and serviced after returning to service.&quot;);</span>

<span class="nc" id="L177">        System.out.println(&quot;\nRequest lifecycle summary:&quot;);</span>
<span class="nc" id="L178">        System.out.println(String.format(&quot;%-40s %-14s %-24s&quot;, &quot;Request&quot;, &quot;Created Tick&quot;, &quot;Completed/Cancelled Tick&quot;));</span>
<span class="nc" id="L179">        System.out.println(&quot;----------------------------------------------------------------------------------------&quot;);</span>
<span class="nc" id="L180">        lifecycles.values().stream()</span>
<span class="nc" id="L181">                .sorted(Comparator.comparingLong(RequestLifecycle::createdTick)</span>
<span class="nc" id="L182">                        .thenComparing(lifecycle -&gt; lifecycle.request().getId()))</span>
<span class="nc" id="L183">                .forEach(lifecycle -&gt; {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                    String completion = lifecycle.terminalTick() == null</span>
<span class="nc" id="L185">                            ? &quot;-&quot;</span>
<span class="nc" id="L186">                            : lifecycle.terminalTick() + &quot; (&quot; + lifecycle.terminalState() + &quot;)&quot;;</span>
<span class="nc" id="L187">                    System.out.println(String.format(&quot;%-40s %-14d %-24s&quot;,</span>
<span class="nc" id="L188">                            formatRequestDescription(lifecycle.request()),</span>
<span class="nc" id="L189">                            lifecycle.createdTick(),</span>
                            completion));
<span class="nc" id="L191">                });</span>
<span class="nc" id="L192">    }</span>

    /**
     * Formats a compact summary of active request states.
     * Shows count of requests in each lifecycle state (e.g., &quot;Q:2 A:1 S:1&quot;).
     */
    private static String formatRequestStatus(RequestManagingLiftController controller) {
<span class="nc" id="L199">        Map&lt;RequestState, Long&gt; stateCounts = controller.getRequests().stream()</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                .filter(request -&gt; !request.isTerminal())</span>
<span class="nc" id="L201">                .collect(Collectors.groupingBy(LiftRequest::getState, Collectors.counting()));</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (stateCounts.isEmpty()) {</span>
<span class="nc" id="L204">            return &quot;-&quot;;</span>
        }

<span class="nc" id="L207">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L208">        long queued = stateCounts.getOrDefault(RequestState.QUEUED, 0L);</span>
<span class="nc" id="L209">        long assigned = stateCounts.getOrDefault(RequestState.ASSIGNED, 0L);</span>
<span class="nc" id="L210">        long serving = stateCounts.getOrDefault(RequestState.SERVING, 0L);</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (queued &gt; 0) sb.append(&quot;Q:&quot;).append(queued).append(&quot; &quot;);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (assigned &gt; 0) sb.append(&quot;A:&quot;).append(assigned).append(&quot; &quot;);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (serving &gt; 0) sb.append(&quot;S:&quot;).append(serving).append(&quot; &quot;);</span>

<span class="nc" id="L216">        return sb.toString().trim();</span>
    }

    private static void recordRequestCreations(RequestManagingLiftController controller,
                                               long tick,
                                               Map&lt;Long, RequestLifecycle&gt; lifecycles) {
<span class="nc bnc" id="L222" title="All 2 branches missed.">        for (LiftRequest request : controller.getRequests()) {</span>
<span class="nc" id="L223">            lifecycles.computeIfAbsent(request.getId(), id -&gt; new RequestLifecycle(request, tick));</span>
<span class="nc" id="L224">        }</span>
<span class="nc" id="L225">    }</span>

    private static void recordTerminalRequests(RequestManagingLiftController controller,
                                               long tick,
                                               Map&lt;Long, RequestLifecycle&gt; lifecycles) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        for (LiftRequest request : controller.getRequests()) {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (!request.isTerminal()) {</span>
<span class="nc" id="L232">                continue;</span>
            }
<span class="nc" id="L234">            RequestLifecycle lifecycle = lifecycles.computeIfAbsent(</span>
<span class="nc" id="L235">                    request.getId(),</span>
<span class="nc" id="L236">                    id -&gt; new RequestLifecycle(request, tick));</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (lifecycle.terminalTick() == null) {</span>
<span class="nc" id="L238">                lifecycle.markTerminal(tick, request.getState());</span>
            }
<span class="nc" id="L240">        }</span>
<span class="nc" id="L241">    }</span>

    private static String formatRequestDescription(LiftRequest request) {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        return switch (request.getType()) {</span>
            case CAR_CALL -&gt; {
<span class="nc" id="L246">                Integer origin = request.getOriginFloor();</span>
<span class="nc" id="L247">                Integer destination = request.getDestinationFloor();</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">                if (origin != null &amp;&amp; destination != null) {</span>
<span class="nc" id="L249">                    yield String.format(&quot;Car call from floor %d to floor %d&quot;, origin, destination);</span>
                }
<span class="nc" id="L251">                yield String.format(&quot;Car call to floor %d&quot;, Objects.requireNonNull(destination));</span>
            }
<span class="nc" id="L253">            case HALL_CALL -&gt; String.format(&quot;Hall call from floor %d (%s)&quot;,</span>
<span class="nc" id="L254">                    request.getOriginFloor(),</span>
<span class="nc" id="L255">                    request.getDirection());</span>
        };
    }

    private static final class RequestLifecycle {
        private final LiftRequest request;
        private final long createdTick;
        private Long terminalTick;
        private RequestState terminalState;

<span class="nc" id="L265">        private RequestLifecycle(LiftRequest request, long createdTick) {</span>
<span class="nc" id="L266">            this.request = request;</span>
<span class="nc" id="L267">            this.createdTick = createdTick;</span>
<span class="nc" id="L268">        }</span>

        private LiftRequest request() {
<span class="nc" id="L271">            return request;</span>
        }

        private long createdTick() {
<span class="nc" id="L275">            return createdTick;</span>
        }

        private Long terminalTick() {
<span class="nc" id="L279">            return terminalTick;</span>
        }

        private RequestState terminalState() {
<span class="nc" id="L283">            return terminalState;</span>
        }

        private void markTerminal(long tick, RequestState state) {
<span class="nc" id="L287">            this.terminalTick = tick;</span>
<span class="nc" id="L288">            this.terminalState = state;</span>
<span class="nc" id="L289">        }</span>
    }

    private static void printUsage() {
<span class="nc" id="L293">        System.out.println(&quot;Usage: java -jar lift-simulator.jar [OPTIONS]&quot;);</span>
<span class="nc" id="L294">        System.out.println();</span>
<span class="nc" id="L295">        System.out.println(&quot;Options:&quot;);</span>
<span class="nc" id="L296">        System.out.println(&quot;  -h, --help                      Show this help message&quot;);</span>
<span class="nc" id="L297">        System.out.println(&quot;  --strategy=&lt;strategy&gt;           Controller strategy to use&quot;);</span>
<span class="nc" id="L298">        System.out.println(&quot;                                  Valid values: nearest-request, directional-scan&quot;);</span>
<span class="nc" id="L299">        System.out.println(&quot;                                  Default: nearest-request&quot;);</span>
<span class="nc" id="L300">        System.out.println();</span>
<span class="nc" id="L301">        System.out.println(&quot;Examples:&quot;);</span>
<span class="nc" id="L302">        System.out.println(&quot;  java -jar lift-simulator.jar&quot;);</span>
<span class="nc" id="L303">        System.out.println(&quot;  java -jar lift-simulator.jar --strategy=directional-scan&quot;);</span>
<span class="nc" id="L304">        System.out.println(&quot;  java -jar lift-simulator.jar --strategy=nearest-request&quot;);</span>
<span class="nc" id="L305">        System.out.println(&quot;  java -jar lift-simulator.jar --help&quot;);</span>
<span class="nc" id="L306">    }</span>

    private static ControllerStrategy parseControllerStrategy(String strategy) {
<span class="nc bnc" id="L309" title="All 3 branches missed.">        return switch (strategy.toLowerCase(Locale.ROOT)) {</span>
<span class="nc" id="L310">            case &quot;nearest-request&quot; -&gt; ControllerStrategy.NEAREST_REQUEST_ROUTING;</span>
<span class="nc" id="L311">            case &quot;directional-scan&quot; -&gt; ControllerStrategy.DIRECTIONAL_SCAN;</span>
<span class="nc" id="L312">            default -&gt; throw new IllegalArgumentException(&quot;Unknown strategy: &quot; + strategy);</span>
        };
    }

    private static String resolveVersion() {
<span class="nc" id="L317">        Properties properties = new Properties();</span>
<span class="nc" id="L318">        try (InputStream inputStream = Main.class.getResourceAsStream(&quot;/version.properties&quot;)) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (inputStream != null) {</span>
<span class="nc" id="L320">                properties.load(inputStream);</span>
<span class="nc" id="L321">                String version = properties.getProperty(&quot;version&quot;);</span>
<span class="nc bnc" id="L322" title="All 4 branches missed.">                if (version != null &amp;&amp; !version.isBlank()) {</span>
<span class="nc" id="L323">                    return version.trim();</span>
                }
            }
<span class="nc bnc" id="L326" title="All 2 branches missed.">        } catch (IOException e) {</span>
<span class="nc" id="L327">            return &quot;unknown&quot;;</span>
<span class="nc" id="L328">        }</span>
<span class="nc" id="L329">        return &quot;unknown&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>