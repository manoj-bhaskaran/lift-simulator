<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BatchInputGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Lift Simulator</a> &gt; <a href="index.source.html" class="el_package">com.liftsimulator.admin.service</a> &gt; <span class="el_source">BatchInputGenerator.java</span></div><h1>BatchInputGenerator.java</h1><pre class="source lang-java linenums">package com.liftsimulator.admin.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.liftsimulator.admin.dto.LiftConfigDTO;
import com.liftsimulator.admin.dto.PassengerFlowDTO;
import com.liftsimulator.admin.dto.ScenarioDefinitionDTO;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Locale;

/**
 * Generates batch simulator input files in the legacy .scenario format.
 * This generator produces backwards-compatible input files that can be consumed
 * by the existing CLI simulator (ScenarioRunnerMain).
 *
 * &lt;p&gt;The generator takes lift system configuration from LiftSystemVersion and
 * passenger flow definitions from ScenarioDefinitionDTO, producing a .scenario file
 * that adheres to the exact format expected by ScenarioParser.
 */
@Service
public class BatchInputGenerator {

    private final ObjectMapper objectMapper;

<span class="nc" id="L32">    public BatchInputGenerator(ObjectMapper objectMapper) {</span>
<span class="nc" id="L33">        this.objectMapper = objectMapper;</span>
<span class="nc" id="L34">    }</span>

    /**
     * Generates a batch input file from lift configuration and scenario definition.
     *
     * @param liftConfigJson JSON string containing LiftConfigDTO configuration
     * @param scenarioDefinition Scenario definition with passenger flows
     * @param scenarioName Name to use in the generated scenario file
     * @param outputPath Path where the .scenario file should be written
     * @throws IOException if file writing fails
     * @throws IllegalArgumentException if configuration or scenario is invalid
     */
    public void generateBatchInputFile(
            String liftConfigJson,
            ScenarioDefinitionDTO scenarioDefinition,
            String scenarioName,
            Path outputPath
    ) throws IOException {
<span class="nc" id="L52">        LiftConfigDTO liftConfig = parseLiftConfig(liftConfigJson);</span>
<span class="nc" id="L53">        String content = generateScenarioContent(liftConfig, scenarioDefinition, scenarioName);</span>
<span class="nc" id="L54">        writeScenarioFile(outputPath, content);</span>
<span class="nc" id="L55">    }</span>

    /**
     * Generates scenario content as a string without writing to file.
     * Useful for testing and validation.
     */
    public String generateScenarioContent(
            LiftConfigDTO liftConfig,
            ScenarioDefinitionDTO scenarioDefinition,
            String scenarioName
    ) {
<span class="nc" id="L66">        validateScenarioAgainstConfig(scenarioDefinition, liftConfig);</span>
<span class="nc" id="L67">        StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L69">        appendHeader(sb, scenarioName);</span>
<span class="nc" id="L70">        appendConfiguration(sb, liftConfig, scenarioDefinition.durationTicks());</span>
<span class="nc" id="L71">        appendEvents(sb, scenarioDefinition.passengerFlows());</span>

<span class="nc" id="L73">        return sb.toString();</span>
    }

    private LiftConfigDTO parseLiftConfig(String liftConfigJson) throws IOException {
        try {
<span class="nc" id="L78">            return objectMapper.readValue(liftConfigJson, LiftConfigDTO.class);</span>
<span class="nc" id="L79">        } catch (IOException e) {</span>
<span class="nc" id="L80">            throw new IOException(&quot;Failed to parse lift configuration JSON: &quot; + e.getMessage(), e);</span>
        }
    }

    private void validateScenarioAgainstConfig(
            ScenarioDefinitionDTO scenario,
            LiftConfigDTO config
    ) {
<span class="nc bnc" id="L88" title="All 2 branches missed.">        for (PassengerFlowDTO flow : scenario.passengerFlows()) {</span>
<span class="nc bnc" id="L89" title="All 4 branches missed.">            if (flow.originFloor() &lt; config.minFloor() || flow.originFloor() &gt; config.maxFloor()) {</span>
<span class="nc" id="L90">                throw new IllegalArgumentException(</span>
<span class="nc" id="L91">                        String.format(</span>
                                &quot;Origin floor %d is outside configured floor range [%d, %d]&quot;,
<span class="nc" id="L93">                                flow.originFloor(),</span>
<span class="nc" id="L94">                                config.minFloor(),</span>
<span class="nc" id="L95">                                config.maxFloor()</span>
                        )
                );
            }
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (flow.destinationFloor() &lt; config.minFloor()</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                    || flow.destinationFloor() &gt; config.maxFloor()) {</span>
<span class="nc" id="L101">                throw new IllegalArgumentException(</span>
<span class="nc" id="L102">                        String.format(</span>
                                &quot;Destination floor %d is outside configured floor range [%d, %d]&quot;,
<span class="nc" id="L104">                                flow.destinationFloor(),</span>
<span class="nc" id="L105">                                config.minFloor(),</span>
<span class="nc" id="L106">                                config.maxFloor()</span>
                        )
                );
            }
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (flow.startTick() &gt;= scenario.durationTicks()) {</span>
<span class="nc" id="L111">                throw new IllegalArgumentException(</span>
<span class="nc" id="L112">                        String.format(</span>
                                &quot;Passenger flow start tick %d must be less than duration %d&quot;,
<span class="nc" id="L114">                                flow.startTick(),</span>
<span class="nc" id="L115">                                scenario.durationTicks()</span>
                        )
                );
            }
<span class="nc" id="L119">        }</span>
<span class="nc" id="L120">    }</span>

    private void appendHeader(StringBuilder sb, String scenarioName) {
<span class="nc" id="L123">        sb.append(&quot;name: &quot;).append(scenarioName).append(&quot;\n&quot;);</span>
<span class="nc" id="L124">    }</span>

    private void appendConfiguration(
            StringBuilder sb,
            LiftConfigDTO config,
            int durationTicks
    ) {
<span class="nc" id="L131">        sb.append(&quot;ticks: &quot;).append(durationTicks).append(&quot;\n&quot;);</span>
<span class="nc" id="L132">        sb.append(&quot;min_floor: &quot;).append(config.minFloor()).append(&quot;\n&quot;);</span>
<span class="nc" id="L133">        sb.append(&quot;max_floor: &quot;).append(config.maxFloor()).append(&quot;\n&quot;);</span>
<span class="nc" id="L134">        sb.append(&quot;initial_floor: &quot;).append(config.homeFloor()).append(&quot;\n&quot;);</span>
<span class="nc" id="L135">        sb.append(&quot;travel_ticks_per_floor: &quot;).append(config.travelTicksPerFloor()).append(&quot;\n&quot;);</span>
<span class="nc" id="L136">        sb.append(&quot;door_transition_ticks: &quot;).append(config.doorTransitionTicks()).append(&quot;\n&quot;);</span>
<span class="nc" id="L137">        sb.append(&quot;door_dwell_ticks: &quot;).append(config.doorDwellTicks()).append(&quot;\n&quot;);</span>
<span class="nc" id="L138">        sb.append(&quot;door_reopen_window_ticks: &quot;).append(config.doorReopenWindowTicks()).append(&quot;\n&quot;);</span>
<span class="nc" id="L139">        sb.append(&quot;home_floor: &quot;).append(config.homeFloor()).append(&quot;\n&quot;);</span>
<span class="nc" id="L140">        sb.append(&quot;idle_timeout_ticks: &quot;).append(config.idleTimeoutTicks()).append(&quot;\n&quot;);</span>
<span class="nc" id="L141">        sb.append(&quot;controller_strategy: &quot;).append(config.controllerStrategy().name()).append(&quot;\n&quot;);</span>
<span class="nc" id="L142">        sb.append(&quot;idle_parking_mode: &quot;).append(config.idleParkingMode().name()).append(&quot;\n&quot;);</span>
<span class="nc" id="L143">        sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L144">    }</span>

    private void appendEvents(StringBuilder sb, List&lt;PassengerFlowDTO&gt; passengerFlows) {
<span class="nc" id="L147">        List&lt;HallCallEvent&gt; events = generateHallCallEvents(passengerFlows);</span>

<span class="nc" id="L149">        events.sort(Comparator.comparingInt(HallCallEvent::tick)</span>
<span class="nc" id="L150">                .thenComparing(HallCallEvent::alias));</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">        for (HallCallEvent event : events) {</span>
<span class="nc" id="L153">            sb.append(event.tick())</span>
<span class="nc" id="L154">              .append(&quot;, hall_call, &quot;)</span>
<span class="nc" id="L155">              .append(event.alias())</span>
<span class="nc" id="L156">              .append(&quot;, &quot;)</span>
<span class="nc" id="L157">              .append(event.originFloor())</span>
<span class="nc" id="L158">              .append(&quot;, &quot;)</span>
<span class="nc" id="L159">              .append(event.direction())</span>
<span class="nc" id="L160">              .append(&quot;\n&quot;);</span>
<span class="nc" id="L161">        }</span>
<span class="nc" id="L162">    }</span>

    private List&lt;HallCallEvent&gt; generateHallCallEvents(List&lt;PassengerFlowDTO&gt; passengerFlows) {
<span class="nc" id="L165">        List&lt;HallCallEvent&gt; events = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L166">        int passengerCounter = 1;</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">        for (PassengerFlowDTO flow : passengerFlows) {</span>
<span class="nc" id="L169">            String direction = determineDirection(flow.originFloor(), flow.destinationFloor());</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">            for (int i = 0; i &lt; flow.passengers(); i++) {</span>
<span class="nc" id="L172">                String alias = String.format(Locale.ROOT, &quot;p%d&quot;, passengerCounter++);</span>
<span class="nc" id="L173">                events.add(new HallCallEvent(</span>
<span class="nc" id="L174">                        flow.startTick(),</span>
                        alias,
<span class="nc" id="L176">                        flow.originFloor(),</span>
                        direction
                ));
            }
<span class="nc" id="L180">        }</span>

<span class="nc" id="L182">        return events;</span>
    }

    private String determineDirection(int originFloor, int destinationFloor) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        return destinationFloor &gt; originFloor ? &quot;UP&quot; : &quot;DOWN&quot;;</span>
    }

    private void writeScenarioFile(Path outputPath, String content) throws IOException {
<span class="nc" id="L190">        Path parentDir = outputPath.getParent();</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">        if (parentDir != null &amp;&amp; !Files.exists(parentDir)) {</span>
<span class="nc" id="L192">            Files.createDirectories(parentDir);</span>
        }

<span class="nc" id="L195">        Files.writeString(</span>
                outputPath,
                content,
                StandardOpenOption.CREATE,
                StandardOpenOption.TRUNCATE_EXISTING
        );
<span class="nc" id="L201">    }</span>

    /**
     * Internal record representing a hall call event in the batch input format.
     */
<span class="nc" id="L206">    private record HallCallEvent(int tick, String alias, int originFloor, String direction) {</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>