<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimulationRunExecutionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Lift Simulator</a> &gt; <a href="index.source.html" class="el_package">com.liftsimulator.admin.service</a> &gt; <span class="el_source">SimulationRunExecutionService.java</span></div><h1>SimulationRunExecutionService.java</h1><pre class="source lang-java linenums">package com.liftsimulator.admin.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.liftsimulator.admin.dto.ConfigValidationResponse;
import com.liftsimulator.admin.dto.LiftConfigDTO;
import com.liftsimulator.admin.dto.PassengerFlowDTO;
import com.liftsimulator.admin.dto.ScenarioDefinitionDTO;
import com.liftsimulator.admin.dto.ScenarioValidationResponse;
import com.liftsimulator.admin.entity.SimulationRun;
import com.liftsimulator.domain.Direction;
import com.liftsimulator.domain.LiftRequest;
import com.liftsimulator.engine.ControllerFactory;
import com.liftsimulator.engine.RequestManagingLiftController;
import com.liftsimulator.engine.SimulationEngine;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.io.BufferedWriter;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.OffsetDateTime;
import java.util.ArrayList;
import java.util.EnumMap;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import jakarta.annotation.PreDestroy;

/**
 * Service to run simulations asynchronously and persist run artefacts.
 */
@Service
public class SimulationRunExecutionService {
<span class="nc" id="L48">    private static final Logger logger = LoggerFactory.getLogger(SimulationRunExecutionService.class);</span>
    private static final int PROGRESS_UPDATE_INTERVAL = 5;
    private static final String CONFIG_FILE_NAME = &quot;config.json&quot;;
    private static final String SCENARIO_FILE_NAME = &quot;scenario.json&quot;;
    private static final String LOG_FILE_NAME = &quot;run.log&quot;;
    private static final String RESULTS_FILE_NAME = &quot;results.json&quot;;

    private final SimulationRunService runService;
    private final ConfigValidationService configValidationService;
    private final ScenarioValidationService scenarioValidationService;
    private final ObjectMapper objectMapper;
    private final ExecutorService executor;
    private final Path artefactsRoot;

    @SuppressFBWarnings(
        value = &quot;EI_EXPOSE_REP2&quot;,
        justification = &quot;Injected dependencies and configuration managed by Spring.&quot;
    )
    public SimulationRunExecutionService(
            SimulationRunService runService,
            ConfigValidationService configValidationService,
            ScenarioValidationService scenarioValidationService,
            ObjectMapper objectMapper,
<span class="nc" id="L71">            @Value(&quot;${simulation.runs.artefacts-root:run-artefacts}&quot;) String artefactsRoot) {</span>
<span class="nc" id="L72">        this.runService = runService;</span>
<span class="nc" id="L73">        this.configValidationService = configValidationService;</span>
<span class="nc" id="L74">        this.scenarioValidationService = scenarioValidationService;</span>
<span class="nc" id="L75">        this.objectMapper = objectMapper;</span>
<span class="nc" id="L76">        this.executor = Executors.newCachedThreadPool(new SimulationRunnerThreadFactory());</span>
<span class="nc" id="L77">        this.artefactsRoot = Paths.get(artefactsRoot);</span>
<span class="nc" id="L78">    }</span>

    /**
     * Creates a simulation run and executes it asynchronously.
     *
     * @param liftSystemId the lift system id
     * @param versionId the version id
     * @param scenarioId optional scenario id
     * @return the created simulation run (CREATED)
     */
    @Transactional
    public SimulationRun startAsyncRun(Long liftSystemId, Long versionId, Long scenarioId) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">        SimulationRun run = scenarioId == null</span>
<span class="nc" id="L91">            ? runService.createRun(liftSystemId, versionId)</span>
<span class="nc" id="L92">            : runService.createRunWithScenario(liftSystemId, versionId, scenarioId);</span>

<span class="nc" id="L94">        String configJson = run.getVersion().getConfig();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        String scenarioJson = run.getScenario() != null ? run.getScenario().getScenarioJson() : null;</span>

<span class="nc" id="L97">        RunExecutionRequest request = new RunExecutionRequest(run.getId(), configJson, scenarioJson);</span>
<span class="nc" id="L98">        executor.execute(() -&gt; executeRun(request));</span>
<span class="nc" id="L99">        return run;</span>
    }

    /**
     * Submits an existing simulation run for asynchronous execution.
     * The run should be in CREATED state with configuration already set.
     *
     * @param runId the run id to execute
     */
    @Transactional
    public void submitRunForExecution(Long runId) {
<span class="nc" id="L110">        SimulationRun run = runService.getRunById(runId);</span>
<span class="nc" id="L111">        String configJson = run.getVersion().getConfig();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        String scenarioJson = run.getScenario() != null ? run.getScenario().getScenarioJson() : null;</span>

<span class="nc" id="L114">        RunExecutionRequest request = new RunExecutionRequest(run.getId(), configJson, scenarioJson);</span>
<span class="nc" id="L115">        executor.execute(() -&gt; executeRun(request));</span>
<span class="nc" id="L116">    }</span>

    private void executeRun(RunExecutionRequest request) {
<span class="nc" id="L119">        Path runDir = buildRunDirectory(request.runId());</span>
<span class="nc" id="L120">        Path logPath = runDir.resolve(LOG_FILE_NAME);</span>
<span class="nc" id="L121">        boolean started = false;</span>

        try {
<span class="nc" id="L124">            Files.createDirectories(runDir);</span>
<span class="nc" id="L125">            runService.configureRun(request.runId(), null, null, runDir.toAbsolutePath().toString());</span>
<span class="nc" id="L126">        } catch (Exception ex) {</span>
<span class="nc" id="L127">            logger.error(&quot;Failed to create run artefact directory for run {}&quot;, request.runId(), ex);</span>
<span class="nc" id="L128">            failRunWithMessage(request.runId(),</span>
<span class="nc" id="L129">                &quot;Failed to initialize run artefacts: &quot; + safeMessage(ex),</span>
                false);
<span class="nc" id="L131">            return;</span>
<span class="nc" id="L132">        }</span>

<span class="nc" id="L134">        try (BufferedWriter logWriter = Files.newBufferedWriter(logPath, StandardCharsets.UTF_8)) {</span>
<span class="nc" id="L135">            log(logWriter, &quot;Run directory initialized at &quot; + runDir.toAbsolutePath());</span>
<span class="nc" id="L136">            writeInputFiles(request, runDir, logWriter);</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (request.scenarioJson() == null) {</span>
<span class="nc" id="L139">                log(logWriter, &quot;Missing scenario payload for run &quot; + request.runId());</span>
<span class="nc" id="L140">                failRunWithMessage(request.runId(), logWriter, &quot;Missing scenario payload for run.&quot;, false);</span>
<span class="nc" id="L141">                writeResults(request.runId(), runDir, null, null, null, &quot;FAILED&quot;, &quot;Missing scenario payload for run.&quot;);</span>
<span class="nc" id="L142">                return;</span>
            }

<span class="nc" id="L145">            ConfigValidationResponse configValidation = configValidationService.validate(request.configJson());</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (!configValidation.valid()) {</span>
<span class="nc" id="L147">                log(logWriter, &quot;Configuration validation failed: &quot; + configValidation.errors());</span>
<span class="nc" id="L148">                failRunWithMessage(request.runId(), logWriter, &quot;Invalid configuration payload.&quot;, false);</span>
<span class="nc" id="L149">                writeResults(request.runId(), runDir, null, null, null, &quot;FAILED&quot;, &quot;Invalid configuration payload.&quot;);</span>
<span class="nc" id="L150">                return;</span>
            }

<span class="nc" id="L153">            JsonNode scenarioNode = objectMapper.readTree(request.scenarioJson());</span>
<span class="nc" id="L154">            ScenarioValidationResponse scenarioValidation = scenarioValidationService.validate(scenarioNode);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (!scenarioValidation.valid()) {</span>
<span class="nc" id="L156">                log(logWriter, &quot;Scenario validation failed: &quot; + scenarioValidation.errors());</span>
<span class="nc" id="L157">                failRunWithMessage(request.runId(), logWriter, &quot;Invalid scenario payload.&quot;, false);</span>
<span class="nc" id="L158">                writeResults(request.runId(), runDir, null, null, null, &quot;FAILED&quot;, &quot;Invalid scenario payload.&quot;);</span>
<span class="nc" id="L159">                return;</span>
            }

<span class="nc" id="L162">            LiftConfigDTO config = objectMapper.readValue(request.configJson(), LiftConfigDTO.class);</span>
<span class="nc" id="L163">            ScenarioDefinitionDTO scenario = objectMapper.readerFor(ScenarioDefinitionDTO.class)</span>
<span class="nc" id="L164">                .readValue(scenarioNode);</span>

<span class="nc" id="L166">            runService.configureRun(</span>
<span class="nc" id="L167">                request.runId(),</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                scenario.durationTicks() != null ? scenario.durationTicks().longValue() : null,</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                scenario.seed() != null ? scenario.seed().longValue() : null,</span>
<span class="nc" id="L170">                runDir.toAbsolutePath().toString()</span>
            );

<span class="nc" id="L173">            runService.startRun(request.runId());</span>
<span class="nc" id="L174">            started = true;</span>
<span class="nc" id="L175">            log(logWriter, &quot;Simulation started for run &quot; + request.runId());</span>

<span class="nc" id="L177">            RunMetrics metrics = runSimulation(request.runId(), config, scenario, logWriter);</span>

<span class="nc" id="L179">            runService.succeedRun(request.runId());</span>
<span class="nc" id="L180">            log(logWriter, &quot;Simulation succeeded for run &quot; + request.runId());</span>
<span class="nc" id="L181">            writeResults(request.runId(), runDir, config, scenario, metrics, &quot;SUCCEEDED&quot;, null);</span>
<span class="nc bnc" id="L182" title="All 6 branches missed.">        } catch (Exception ex) {</span>
<span class="nc" id="L183">            String errorMessage = safeMessage(ex);</span>
<span class="nc" id="L184">            logger.error(&quot;Simulation run {} failed&quot;, request.runId(), ex);</span>
<span class="nc" id="L185">            failRunWithMessage(request.runId(), logPath, errorMessage, started);</span>
            try {
<span class="nc" id="L187">                writeResults(request.runId(), runDir, null, null, null, &quot;FAILED&quot;, errorMessage);</span>
<span class="nc" id="L188">            } catch (IOException ioEx) {</span>
<span class="nc" id="L189">                logger.warn(&quot;Failed to write results file for run {}&quot;, request.runId(), ioEx);</span>
<span class="nc" id="L190">            }</span>
<span class="nc" id="L191">        }</span>
<span class="nc" id="L192">    }</span>

    private RunMetrics runSimulation(Long runId,
                                     LiftConfigDTO config,
                                     ScenarioDefinitionDTO scenario,
                                     BufferedWriter logWriter) throws IOException {
<span class="nc" id="L198">        RequestManagingLiftController controller = (RequestManagingLiftController) ControllerFactory.createController(</span>
<span class="nc" id="L199">            config.controllerStrategy(),</span>
<span class="nc" id="L200">            config.homeFloor(),</span>
<span class="nc" id="L201">            config.idleTimeoutTicks(),</span>
<span class="nc" id="L202">            config.idleParkingMode()</span>
        );

<span class="nc" id="L205">        SimulationEngine engine = SimulationEngine.builder(controller, config.minFloor(), config.maxFloor())</span>
<span class="nc" id="L206">            .initialFloor(config.homeFloor())</span>
<span class="nc" id="L207">            .travelTicksPerFloor(config.travelTicksPerFloor())</span>
<span class="nc" id="L208">            .doorTransitionTicks(config.doorTransitionTicks())</span>
<span class="nc" id="L209">            .doorDwellTicks(config.doorDwellTicks())</span>
<span class="nc" id="L210">            .doorReopenWindowTicks(config.doorReopenWindowTicks())</span>
<span class="nc" id="L211">            .build();</span>

<span class="nc" id="L213">        Map&lt;Integer, List&lt;PassengerFlowDTO&gt;&gt; flowsByTick = groupFlowsByTick(scenario);</span>
<span class="nc" id="L214">        RunMetrics metrics = new RunMetrics(config.minFloor(), config.maxFloor());</span>

<span class="nc" id="L216">        log(logWriter, &quot;Starting simulation for &quot; + scenario.durationTicks() + &quot; ticks.&quot;);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        for (int tick = 0; tick &lt; scenario.durationTicks(); tick++) {</span>
<span class="nc" id="L218">            long currentTick = engine.getCurrentTick();</span>
<span class="nc" id="L219">            List&lt;PassengerFlowDTO&gt; flows = flowsByTick.getOrDefault((int) currentTick, List.of());</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            for (PassengerFlowDTO flow : flows) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                int passengers = flow.passengers() != null ? flow.passengers() : 1;</span>
<span class="nc" id="L222">                metrics.recordPassengerFlow(flow, passengers);</span>

                // Determine direction based on origin and destination floors
                Direction direction;
<span class="nc bnc" id="L226" title="All 2 branches missed.">                if (flow.destinationFloor() &gt; flow.originFloor()) {</span>
<span class="nc" id="L227">                    direction = Direction.UP;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                } else if (flow.destinationFloor() &lt; flow.originFloor()) {</span>
<span class="nc" id="L229">                    direction = Direction.DOWN;</span>
                } else {
                    // Same floor - skip this flow as it doesn't require lift movement
                    continue;
                }

                // Create hall calls (not car calls) to properly model passenger pickup
<span class="nc bnc" id="L236" title="All 2 branches missed.">                for (int i = 0; i &lt; passengers; i++) {</span>
<span class="nc" id="L237">                    LiftRequest request = LiftRequest.hallCall(flow.originFloor(), direction);</span>
<span class="nc" id="L238">                    metrics.recordRequestCreation(request, currentTick);</span>
<span class="nc" id="L239">                    controller.addRequest(request);</span>
                }
<span class="nc" id="L241">            }</span>

<span class="nc" id="L243">            metrics.recordLiftState(engine.getCurrentState());</span>
<span class="nc" id="L244">            metrics.recordActiveRequests(controller.getRequests(), currentTick);</span>
<span class="nc" id="L245">            engine.tick();</span>
<span class="nc" id="L246">            metrics.recordTerminalRequests(currentTick);</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (tick % PROGRESS_UPDATE_INTERVAL == 0) {</span>
<span class="nc" id="L249">                runService.updateProgress(runId, engine.getCurrentTick());</span>
            }
        }

<span class="nc" id="L253">        runService.updateProgress(runId, engine.getCurrentTick());</span>
<span class="nc" id="L254">        log(logWriter, &quot;Simulation completed at tick &quot; + engine.getCurrentTick());</span>
<span class="nc" id="L255">        metrics.recordTerminalRequests(engine.getCurrentTick());</span>
<span class="nc" id="L256">        return metrics;</span>
    }

    private Map&lt;Integer, List&lt;PassengerFlowDTO&gt;&gt; groupFlowsByTick(ScenarioDefinitionDTO scenario) {
<span class="nc" id="L260">        Map&lt;Integer, List&lt;PassengerFlowDTO&gt;&gt; flowsByTick = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (scenario.passengerFlows() == null) {</span>
<span class="nc" id="L262">            return flowsByTick;</span>
        }

<span class="nc bnc" id="L265" title="All 2 branches missed.">        for (PassengerFlowDTO flow : scenario.passengerFlows()) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">            int tick = flow.startTick() != null ? flow.startTick() : 0;</span>
<span class="nc" id="L267">            flowsByTick.computeIfAbsent(tick, key -&gt; new ArrayList&lt;&gt;()).add(flow);</span>
<span class="nc" id="L268">        }</span>
<span class="nc" id="L269">        return flowsByTick;</span>
    }

    private void writeInputFiles(RunExecutionRequest request, Path runDir, BufferedWriter logWriter) throws IOException {
<span class="nc" id="L273">        Files.writeString(runDir.resolve(CONFIG_FILE_NAME), request.configJson(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L274">        log(logWriter, &quot;Wrote config input to &quot; + CONFIG_FILE_NAME);</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (request.scenarioJson() != null) {</span>
<span class="nc" id="L277">            Files.writeString(runDir.resolve(SCENARIO_FILE_NAME), request.scenarioJson(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L278">            log(logWriter, &quot;Wrote scenario input to &quot; + SCENARIO_FILE_NAME);</span>
        }
<span class="nc" id="L280">    }</span>

    private void failRunWithMessage(Long runId, BufferedWriter logWriter, String message, boolean started) throws IOException {
<span class="nc" id="L283">        log(logWriter, &quot;Run failed: &quot; + message);</span>
<span class="nc" id="L284">        failRunWithMessage(runId, message, started);</span>
<span class="nc" id="L285">    }</span>

    private void failRunWithMessage(Long runId, Path logPath, String message, boolean started) {
<span class="nc" id="L288">        try (BufferedWriter logWriter = Files.newBufferedWriter(logPath, StandardCharsets.UTF_8, java.nio.file.StandardOpenOption.APPEND)) {</span>
<span class="nc" id="L289">            log(logWriter, &quot;Run failed: &quot; + message);</span>
<span class="nc" id="L290">        } catch (IOException ex) {</span>
<span class="nc" id="L291">            logger.warn(&quot;Failed to append failure message to run log for run {}&quot;, runId, ex);</span>
<span class="nc" id="L292">        }</span>
<span class="nc" id="L293">        failRunWithMessage(runId, message, started);</span>
<span class="nc" id="L294">    }</span>

    private void failRunWithMessage(Long runId, String message, boolean started) {
        try {
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (!started) {</span>
<span class="nc" id="L299">                runService.startRun(runId);</span>
            }
<span class="nc" id="L301">            runService.failRun(runId, message);</span>
<span class="nc" id="L302">        } catch (Exception ex) {</span>
<span class="nc" id="L303">            logger.error(&quot;Failed to mark run {} as failed&quot;, runId, ex);</span>
<span class="nc" id="L304">        }</span>
<span class="nc" id="L305">    }</span>

    private void writeResults(Long runId,
                              Path runDir,
                              LiftConfigDTO config,
                              ScenarioDefinitionDTO scenario,
                              RunMetrics metrics,
                              String status,
                              String message) throws IOException {
<span class="nc" id="L314">        ObjectNode results = objectMapper.createObjectNode();</span>
<span class="nc" id="L315">        ObjectNode runSummary = results.putObject(&quot;runSummary&quot;);</span>
<span class="nc" id="L316">        runSummary.put(&quot;runId&quot;, runId);</span>
<span class="nc" id="L317">        runSummary.put(&quot;status&quot;, status);</span>
<span class="nc" id="L318">        runSummary.put(&quot;generatedAt&quot;, OffsetDateTime.now().toString());</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (message != null) {</span>
<span class="nc" id="L320">            runSummary.put(&quot;message&quot;, message);</span>
        }
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (scenario != null) {</span>
<span class="nc" id="L323">            runSummary.put(&quot;durationTicks&quot;, scenario.durationTicks());</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (scenario.seed() != null) {</span>
<span class="nc" id="L325">                runSummary.put(&quot;seed&quot;, scenario.seed());</span>
            }
        }
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (metrics != null) {</span>
<span class="nc" id="L329">            runSummary.put(&quot;ticks&quot;, metrics.totalTicks());</span>
        }
        try {
<span class="nc" id="L332">            SimulationRun run = runService.getRunById(runId);</span>
<span class="nc" id="L333">            runSummary.put(&quot;liftSystemId&quot;, run.getLiftSystem().getId());</span>
<span class="nc" id="L334">            runSummary.put(&quot;versionId&quot;, run.getVersion().getId());</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (run.getScenario() != null) {</span>
<span class="nc" id="L336">                runSummary.put(&quot;scenarioId&quot;, run.getScenario().getId());</span>
            }
<span class="nc" id="L338">        } catch (Exception ex) {</span>
<span class="nc" id="L339">            logger.warn(&quot;Failed to resolve run summary metadata for run {}&quot;, runId, ex);</span>
<span class="nc" id="L340">        }</span>

<span class="nc bnc" id="L342" title="All 4 branches missed.">        if (metrics != null &amp;&amp; config != null) {</span>
<span class="nc" id="L343">            results.set(&quot;kpis&quot;, metrics.toKpisNode(objectMapper));</span>
<span class="nc" id="L344">            results.set(&quot;perLift&quot;, metrics.toPerLiftNode(objectMapper, config));</span>
<span class="nc" id="L345">            results.set(&quot;perFloor&quot;, metrics.toPerFloorNode(objectMapper));</span>
        }

<span class="nc" id="L348">        objectMapper.writerWithDefaultPrettyPrinter()</span>
<span class="nc" id="L349">            .writeValue(runDir.resolve(RESULTS_FILE_NAME).toFile(), results);</span>
<span class="nc" id="L350">    }</span>

    private Path buildRunDirectory(Long runId) {
<span class="nc" id="L353">        return artefactsRoot.resolve(&quot;run-&quot; + runId);</span>
    }

    private void log(BufferedWriter writer, String message) throws IOException {
<span class="nc" id="L357">        writer.write(&quot;[&quot; + OffsetDateTime.now() + &quot;] &quot; + message);</span>
<span class="nc" id="L358">        writer.newLine();</span>
<span class="nc" id="L359">        writer.flush();</span>
<span class="nc" id="L360">    }</span>

    private String safeMessage(Exception ex) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">        return ex.getMessage() != null ? ex.getMessage() : &quot;Unexpected simulation failure&quot;;</span>
    }

    @PreDestroy
    public void shutdownExecutor() {
<span class="nc" id="L368">        executor.shutdown();</span>
<span class="nc" id="L369">    }</span>

<span class="nc" id="L371">    private record RunExecutionRequest(Long runId, String configJson, String scenarioJson) {</span>
    }

<span class="nc" id="L374">    private static final class SimulationRunnerThreadFactory implements ThreadFactory {</span>
<span class="nc" id="L375">        private int counter = 1;</span>

        @Override
        public synchronized Thread newThread(Runnable runnable) {
<span class="nc" id="L379">            Thread thread = new Thread(runnable, &quot;simulation-runner-&quot; + counter++);</span>
<span class="nc" id="L380">            thread.setDaemon(true);</span>
<span class="nc" id="L381">            return thread;</span>
        }
    }

    private static final class RunMetrics {
<span class="nc" id="L386">        private final Map&lt;Long, RequestLifecycle&gt; lifecycles = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L387">        private final Map&lt;com.liftsimulator.domain.LiftStatus, Long&gt; statusCounts = new EnumMap&lt;&gt;(com.liftsimulator.domain.LiftStatus.class);</span>
<span class="nc" id="L388">        private final Map&lt;Integer, FloorMetrics&gt; floorMetrics = new HashMap&lt;&gt;();</span>
        private final int minFloor;
        private final int maxFloor;
        private long totalTicks;
        private Integer lastRecordedFloor;

<span class="nc" id="L394">        private RunMetrics(int minFloor, int maxFloor) {</span>
<span class="nc" id="L395">            this.minFloor = minFloor;</span>
<span class="nc" id="L396">            this.maxFloor = maxFloor;</span>
<span class="nc" id="L397">        }</span>

        private void recordPassengerFlow(PassengerFlowDTO flow, int passengers) {
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (flow.originFloor() != null) {</span>
<span class="nc" id="L401">                floorMetrics.computeIfAbsent(flow.originFloor(), FloorMetrics::new)</span>
<span class="nc" id="L402">                    .addOrigins(passengers);</span>
            }
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (flow.destinationFloor() != null) {</span>
<span class="nc" id="L405">                floorMetrics.computeIfAbsent(flow.destinationFloor(), FloorMetrics::new)</span>
<span class="nc" id="L406">                    .addDestinations(passengers);</span>
            }
<span class="nc" id="L408">        }</span>

        private void recordLiftState(com.liftsimulator.domain.LiftState state) {
<span class="nc" id="L411">            statusCounts.merge(state.getStatus(), 1L, Long::sum);</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">            if (lastRecordedFloor == null || lastRecordedFloor != state.getFloor()) {</span>
<span class="nc" id="L413">                floorMetrics.computeIfAbsent(state.getFloor(), FloorMetrics::new)</span>
<span class="nc" id="L414">                    .addVisit();</span>
<span class="nc" id="L415">                lastRecordedFloor = state.getFloor();</span>
            }
<span class="nc" id="L417">            totalTicks++;</span>
<span class="nc" id="L418">        }</span>

        private void recordRequestCreation(LiftRequest request, long tick) {
<span class="nc" id="L421">            lifecycles.computeIfAbsent(request.getId(), id -&gt; new RequestLifecycle(request, tick));</span>
<span class="nc" id="L422">        }</span>

        private void recordActiveRequests(Set&lt;LiftRequest&gt; requests, long tick) {
<span class="nc bnc" id="L425" title="All 2 branches missed.">            for (LiftRequest request : requests) {</span>
<span class="nc" id="L426">                recordRequestCreation(request, tick);</span>
<span class="nc" id="L427">            }</span>
<span class="nc" id="L428">        }</span>

        private void recordTerminalRequests(long tick) {
<span class="nc bnc" id="L431" title="All 2 branches missed.">            for (RequestLifecycle lifecycle : lifecycles.values()) {</span>
<span class="nc bnc" id="L432" title="All 4 branches missed.">                if (lifecycle.terminalTick() != null || !lifecycle.request().isTerminal()) {</span>
<span class="nc" id="L433">                    continue;</span>
                }
<span class="nc" id="L435">                lifecycle.markTerminal(tick, lifecycle.request().getState());</span>
<span class="nc" id="L436">            }</span>
<span class="nc" id="L437">        }</span>

        private long totalTicks() {
<span class="nc" id="L440">            return totalTicks;</span>
        }

        private ObjectNode toKpisNode(ObjectMapper objectMapper) {
<span class="nc" id="L444">            ObjectNode kpis = objectMapper.createObjectNode();</span>
<span class="nc" id="L445">            long completed = lifecycles.values().stream()</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                .filter(lifecycle -&gt; lifecycle.terminalState() == com.liftsimulator.domain.RequestState.COMPLETED)</span>
<span class="nc" id="L447">                .count();</span>
<span class="nc" id="L448">            long cancelled = lifecycles.values().stream()</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                .filter(lifecycle -&gt; lifecycle.terminalState() == com.liftsimulator.domain.RequestState.CANCELLED)</span>
<span class="nc" id="L450">                .count();</span>
<span class="nc" id="L451">            long maxWait = lifecycles.values().stream()</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                .filter(lifecycle -&gt; lifecycle.terminalState() == com.liftsimulator.domain.RequestState.COMPLETED)</span>
<span class="nc" id="L453">                .mapToLong(RequestLifecycle::waitTicks)</span>
<span class="nc" id="L454">                .max()</span>
<span class="nc" id="L455">                .orElse(0L);</span>
<span class="nc" id="L456">            double avgWait = lifecycles.values().stream()</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                .filter(lifecycle -&gt; lifecycle.terminalState() == com.liftsimulator.domain.RequestState.COMPLETED)</span>
<span class="nc" id="L458">                .mapToLong(RequestLifecycle::waitTicks)</span>
<span class="nc" id="L459">                .average()</span>
<span class="nc" id="L460">                .orElse(0.0);</span>

<span class="nc" id="L462">            long idleTicks = statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.IDLE, 0L)</span>
<span class="nc" id="L463">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.OUT_OF_SERVICE, 0L);</span>
<span class="nc" id="L464">            long movingTicks = statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.MOVING_UP, 0L)</span>
<span class="nc" id="L465">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.MOVING_DOWN, 0L);</span>
<span class="nc" id="L466">            long doorTicks = statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.DOORS_OPENING, 0L)</span>
<span class="nc" id="L467">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.DOORS_OPEN, 0L)</span>
<span class="nc" id="L468">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.DOORS_CLOSING, 0L);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">            double utilisation = totalTicks == 0 ? 0.0 : (double) (movingTicks + doorTicks) / (double) totalTicks;</span>

<span class="nc" id="L471">            kpis.put(&quot;requestsTotal&quot;, lifecycles.size());</span>
<span class="nc" id="L472">            kpis.put(&quot;passengersServed&quot;, completed);</span>
<span class="nc" id="L473">            kpis.put(&quot;passengersCancelled&quot;, cancelled);</span>
<span class="nc" id="L474">            kpis.put(&quot;avgWaitTicks&quot;, avgWait);</span>
<span class="nc" id="L475">            kpis.put(&quot;maxWaitTicks&quot;, maxWait);</span>
<span class="nc" id="L476">            kpis.put(&quot;idleTicks&quot;, idleTicks);</span>
<span class="nc" id="L477">            kpis.put(&quot;movingTicks&quot;, movingTicks);</span>
<span class="nc" id="L478">            kpis.put(&quot;doorTicks&quot;, doorTicks);</span>
<span class="nc" id="L479">            kpis.put(&quot;utilisation&quot;, utilisation);</span>
<span class="nc" id="L480">            return kpis;</span>
        }

        private com.fasterxml.jackson.databind.node.ArrayNode toPerLiftNode(ObjectMapper objectMapper, LiftConfigDTO config) {
<span class="nc" id="L484">            com.fasterxml.jackson.databind.node.ArrayNode lifts = objectMapper.createArrayNode();</span>
<span class="nc" id="L485">            ObjectNode lift = objectMapper.createObjectNode();</span>
<span class="nc" id="L486">            lift.put(&quot;liftId&quot;, &quot;lift-1&quot;);</span>
<span class="nc" id="L487">            lift.put(&quot;minFloor&quot;, minFloor);</span>
<span class="nc" id="L488">            lift.put(&quot;maxFloor&quot;, maxFloor);</span>
<span class="nc" id="L489">            lift.put(&quot;homeFloor&quot;, config.homeFloor());</span>
<span class="nc" id="L490">            lift.put(&quot;travelTicksPerFloor&quot;, config.travelTicksPerFloor());</span>
<span class="nc" id="L491">            lift.put(&quot;doorTransitionTicks&quot;, config.doorTransitionTicks());</span>
<span class="nc" id="L492">            lift.put(&quot;doorDwellTicks&quot;, config.doorDwellTicks());</span>
<span class="nc" id="L493">            lift.put(&quot;doorReopenWindowTicks&quot;, config.doorReopenWindowTicks());</span>
<span class="nc" id="L494">            lift.put(&quot;controllerStrategy&quot;, config.controllerStrategy().name());</span>
<span class="nc" id="L495">            lift.put(&quot;idleParkingMode&quot;, config.idleParkingMode().name());</span>

<span class="nc" id="L497">            ObjectNode statusNode = objectMapper.createObjectNode();</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">            for (Map.Entry&lt;com.liftsimulator.domain.LiftStatus, Long&gt; entry : statusCounts.entrySet()) {</span>
<span class="nc" id="L499">                statusNode.put(entry.getKey().name(), entry.getValue());</span>
<span class="nc" id="L500">            }</span>
<span class="nc" id="L501">            lift.set(&quot;statusCounts&quot;, statusNode);</span>

<span class="nc" id="L503">            long idleTicks = statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.IDLE, 0L)</span>
<span class="nc" id="L504">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.OUT_OF_SERVICE, 0L);</span>
<span class="nc" id="L505">            long movingTicks = statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.MOVING_UP, 0L)</span>
<span class="nc" id="L506">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.MOVING_DOWN, 0L);</span>
<span class="nc" id="L507">            long doorTicks = statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.DOORS_OPENING, 0L)</span>
<span class="nc" id="L508">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.DOORS_OPEN, 0L)</span>
<span class="nc" id="L509">                + statusCounts.getOrDefault(com.liftsimulator.domain.LiftStatus.DOORS_CLOSING, 0L);</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">            double utilisation = totalTicks == 0 ? 0.0 : (double) (movingTicks + doorTicks) / (double) totalTicks;</span>

<span class="nc" id="L512">            lift.put(&quot;totalTicks&quot;, totalTicks);</span>
<span class="nc" id="L513">            lift.put(&quot;idleTicks&quot;, idleTicks);</span>
<span class="nc" id="L514">            lift.put(&quot;movingTicks&quot;, movingTicks);</span>
<span class="nc" id="L515">            lift.put(&quot;doorTicks&quot;, doorTicks);</span>
<span class="nc" id="L516">            lift.put(&quot;utilisation&quot;, utilisation);</span>

<span class="nc" id="L518">            lifts.add(lift);</span>
<span class="nc" id="L519">            return lifts;</span>
        }

        private com.fasterxml.jackson.databind.node.ArrayNode toPerFloorNode(ObjectMapper objectMapper) {
<span class="nc" id="L523">            com.fasterxml.jackson.databind.node.ArrayNode floors = objectMapper.createArrayNode();</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">            for (int floor = minFloor; floor &lt;= maxFloor; floor++) {</span>
<span class="nc" id="L525">                FloorMetrics metrics = floorMetrics.getOrDefault(floor, new FloorMetrics(floor));</span>
<span class="nc" id="L526">                ObjectNode floorNode = objectMapper.createObjectNode();</span>
<span class="nc" id="L527">                floorNode.put(&quot;floor&quot;, floor);</span>
<span class="nc" id="L528">                floorNode.put(&quot;originPassengers&quot;, metrics.originPassengers());</span>
<span class="nc" id="L529">                floorNode.put(&quot;destinationPassengers&quot;, metrics.destinationPassengers());</span>
<span class="nc" id="L530">                floorNode.put(&quot;liftVisits&quot;, metrics.liftVisits());</span>
<span class="nc" id="L531">                floors.add(floorNode);</span>
            }
<span class="nc" id="L533">            return floors;</span>
        }
    }

    private static final class FloorMetrics {
        private long originPassengers;
        private long destinationPassengers;
        private long liftVisits;

<span class="nc" id="L542">        private FloorMetrics(int floor) {</span>
<span class="nc" id="L543">        }</span>

        private void addOrigins(long count) {
<span class="nc" id="L546">            originPassengers += count;</span>
<span class="nc" id="L547">        }</span>

        private void addDestinations(long count) {
<span class="nc" id="L550">            destinationPassengers += count;</span>
<span class="nc" id="L551">        }</span>

        private void addVisit() {
<span class="nc" id="L554">            liftVisits++;</span>
<span class="nc" id="L555">        }</span>

        private long originPassengers() {
<span class="nc" id="L558">            return originPassengers;</span>
        }

        private long destinationPassengers() {
<span class="nc" id="L562">            return destinationPassengers;</span>
        }

        private long liftVisits() {
<span class="nc" id="L566">            return liftVisits;</span>
        }
    }

    private static final class RequestLifecycle {
        private final LiftRequest request;
        private final long createdTick;
        private Long terminalTick;
        private com.liftsimulator.domain.RequestState terminalState;

<span class="nc" id="L576">        private RequestLifecycle(LiftRequest request, long createdTick) {</span>
<span class="nc" id="L577">            this.request = request;</span>
<span class="nc" id="L578">            this.createdTick = createdTick;</span>
<span class="nc" id="L579">        }</span>

        private LiftRequest request() {
<span class="nc" id="L582">            return request;</span>
        }

        private Long terminalTick() {
<span class="nc" id="L586">            return terminalTick;</span>
        }

        private com.liftsimulator.domain.RequestState terminalState() {
<span class="nc" id="L590">            return terminalState;</span>
        }

        private long waitTicks() {
<span class="nc bnc" id="L594" title="All 2 branches missed.">            if (terminalTick == null) {</span>
<span class="nc" id="L595">                return 0L;</span>
            }
<span class="nc" id="L597">            return Math.max(0L, terminalTick - createdTick);</span>
        }

        private void markTerminal(long tick, com.liftsimulator.domain.RequestState state) {
<span class="nc" id="L601">            this.terminalTick = tick;</span>
<span class="nc" id="L602">            this.terminalState = state;</span>
<span class="nc" id="L603">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>