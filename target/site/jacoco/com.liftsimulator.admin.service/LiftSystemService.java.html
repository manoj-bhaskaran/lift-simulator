<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LiftSystemService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Lift Simulator</a> &gt; <a href="index.source.html" class="el_package">com.liftsimulator.admin.service</a> &gt; <span class="el_source">LiftSystemService.java</span></div><h1>LiftSystemService.java</h1><pre class="source lang-java linenums">package com.liftsimulator.admin.service;

import com.liftsimulator.admin.dto.CreateLiftSystemRequest;
import com.liftsimulator.admin.dto.LiftSystemResponse;
import com.liftsimulator.admin.dto.UpdateLiftSystemRequest;
import com.liftsimulator.admin.entity.LiftSystem;
import com.liftsimulator.admin.repository.LiftSystemRepository;
import com.liftsimulator.admin.repository.LiftSystemVersionRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Service for managing lift systems.
 */
@Service
@Transactional(readOnly = true)
public class LiftSystemService {

    private final LiftSystemRepository liftSystemRepository;
    private final LiftSystemVersionRepository liftSystemVersionRepository;

    public LiftSystemService(
            LiftSystemRepository liftSystemRepository,
            LiftSystemVersionRepository liftSystemVersionRepository
<span class="nc" id="L29">    ) {</span>
<span class="nc" id="L30">        this.liftSystemRepository = liftSystemRepository;</span>
<span class="nc" id="L31">        this.liftSystemVersionRepository = liftSystemVersionRepository;</span>
<span class="nc" id="L32">    }</span>

    /**
     * Creates a new lift system.
     *
     * @param request the creation request
     * @return the created lift system
     * @throws IllegalArgumentException if system key already exists
     */
    @Transactional
    public LiftSystemResponse createLiftSystem(CreateLiftSystemRequest request) {
<span class="nc bnc" id="L43" title="All 2 branches missed.">        if (liftSystemRepository.existsBySystemKey(request.systemKey())) {</span>
<span class="nc" id="L44">            throw new IllegalArgumentException(</span>
<span class="nc" id="L45">                &quot;Lift system with key '&quot; + request.systemKey() + &quot;' already exists&quot;</span>
            );
        }

<span class="nc" id="L49">        LiftSystem liftSystem = new LiftSystem();</span>
<span class="nc" id="L50">        liftSystem.setSystemKey(request.systemKey());</span>
<span class="nc" id="L51">        liftSystem.setDisplayName(request.displayName());</span>
<span class="nc" id="L52">        liftSystem.setDescription(request.description());</span>

<span class="nc" id="L54">        LiftSystem savedSystem = liftSystemRepository.save(liftSystem);</span>
<span class="nc" id="L55">        return LiftSystemResponse.fromEntity(savedSystem, 0);</span>
    }

    /**
     * Retrieves all lift systems.
     *
     * @return list of all lift systems
     */
    public List&lt;LiftSystemResponse&gt; getAllLiftSystems() {
<span class="nc" id="L64">        List&lt;LiftSystem&gt; systems = liftSystemRepository.findAll();</span>
<span class="nc" id="L65">        Map&lt;Long, Long&gt; versionCounts = loadVersionCounts();</span>
<span class="nc" id="L66">        return systems.stream()</span>
<span class="nc" id="L67">            .map(system -&gt; LiftSystemResponse.fromEntity(</span>
                system,
<span class="nc" id="L69">                versionCounts.getOrDefault(system.getId(), 0L)</span>
            ))
<span class="nc" id="L71">            .toList();</span>
    }

    /**
     * Retrieves a lift system by ID.
     *
     * @param id the system ID
     * @return the lift system
     * @throws ResourceNotFoundException if not found
     */
    public LiftSystemResponse getLiftSystemById(Long id) {
<span class="nc" id="L82">        LiftSystem liftSystem = liftSystemRepository.findById(id)</span>
<span class="nc" id="L83">            .orElseThrow(() -&gt; new ResourceNotFoundException(</span>
                &quot;Lift system not found with id: &quot; + id
            ));
<span class="nc" id="L86">        long versionCount = liftSystemVersionRepository.countByLiftSystemId(liftSystem.getId());</span>
<span class="nc" id="L87">        return LiftSystemResponse.fromEntity(liftSystem, versionCount);</span>
    }

    /**
     * Updates lift system metadata.
     *
     * @param id the system ID
     * @param request the update request
     * @return the updated lift system
     * @throws ResourceNotFoundException if not found
     */
    @Transactional
    public LiftSystemResponse updateLiftSystem(Long id, UpdateLiftSystemRequest request) {
<span class="nc" id="L100">        LiftSystem liftSystem = liftSystemRepository.findById(id)</span>
<span class="nc" id="L101">            .orElseThrow(() -&gt; new ResourceNotFoundException(</span>
                &quot;Lift system not found with id: &quot; + id
            ));

<span class="nc" id="L105">        liftSystem.setDisplayName(request.displayName());</span>
<span class="nc" id="L106">        liftSystem.setDescription(request.description());</span>

<span class="nc" id="L108">        LiftSystem updatedSystem = liftSystemRepository.save(liftSystem);</span>
<span class="nc" id="L109">        long versionCount = liftSystemVersionRepository.countByLiftSystemId(updatedSystem.getId());</span>
<span class="nc" id="L110">        return LiftSystemResponse.fromEntity(updatedSystem, versionCount);</span>
    }

    /**
     * Deletes a lift system and all its versions.
     *
     * @param id the system ID
     * @throws ResourceNotFoundException if not found
     */
    @Transactional
    public void deleteLiftSystem(Long id) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!liftSystemRepository.existsById(id)) {</span>
<span class="nc" id="L122">            throw new ResourceNotFoundException(</span>
                &quot;Lift system not found with id: &quot; + id
            );
        }
<span class="nc" id="L126">        liftSystemRepository.deleteById(id);</span>
<span class="nc" id="L127">    }</span>

    private Map&lt;Long, Long&gt; loadVersionCounts() {
<span class="nc" id="L130">        Map&lt;Long, Long&gt; counts = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        for (Object[] row : liftSystemVersionRepository.countVersionsByLiftSystemId()) {</span>
<span class="nc" id="L132">            Long systemId = ((Number) row[0]).longValue();</span>
<span class="nc" id="L133">            Long count = ((Number) row[1]).longValue();</span>
<span class="nc" id="L134">            counts.put(systemId, count);</span>
<span class="nc" id="L135">        }</span>
<span class="nc" id="L136">        return counts;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>